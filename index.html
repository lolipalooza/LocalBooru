<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My App Layout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  
  <link rel="stylesheet" type="text/css" href="node_modules/sweetalert2/dist/sweetalert2.min.css">

  <!-- animate.css: https://animate.style/ -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/animate.css@4.0.0/animate.min.css">

  <link rel="stylesheet" type="text/css" href="pagination.css">
  <link rel="stylesheet" type="text/css" href="checkbox.css">

  <style type="text/css">
    /* width */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
      box-shadow: inset 0 0 5px rgb(128 128 128 / 60%);
      border-radius: 10px;
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: rgb(47 54 64 / 50%);
      border-radius: 10px;
    }

    .side::-webkit-scrollbar, .gallery::-webkit-scrollbar {
      width: 0;
    }

    .side:hover::-webkit-scrollbar, .gallery:hover::-webkit-scrollbar {
      width: 6px;
    }

    section, div {
      box-sizing: content-box;
    }
    body{
      font-family: verdana, sans-serif, helvetica;
      font-size: .71em;
      background: url(https://static.vecteezy.com/system/resources/previews/001/409/192/original/abstract-geometric-banner-free-vector.jpg) fixed;
      box-shadow: inset 0 0 0 1000px rgba(113, 25, 50, 0.65);
      margin: 0;
      padding: 0;
      color: #fff;
      overflow: hidden;
    }
    .text-left {
      text-align: left;
    }
    ._menu {
      position: fixed;
      top: 0;
      width: calc(100vw - 20px);
      height: 24px;
      background: #2f3640;
      display: flex;
      padding: 0px 10px;
      align-items: center;
      justify-content: end;
    }
    ._menu.draggable {
      -webkit-user-select: none;
      -webkit-app-region: drag;
    }
    ._menu .no-drag {
      -webkit-app-region: no-drag;
    }
    ._menu > div > span {
      padding: 0 4px;
      text-shadow: 1px 1px 0 rgb(0 0 0 / 85%);
      transition: all 1s ease;
    }
    ._menu > div > span:hover {
      color: #c8e71f;
      opacity: 1;
    }
    .btn-close {
      background: none;
      color: #fff;
      opacity: 1;
    }
    .header {
      position: fixed;
      top: 30px;
      width: calc(100% - 12px * 2);
      z-index: 1;
      padding: 0px 12px;
    }
    .content {
      display: flex;
      padding: 48px 0;
    }
    .side {
      padding-left: 12px;
      flex-basis: 12rem;
      flex-grow: 0;
      flex-shrink: 0;
      height: calc(100vh - 68px);
      overflow-y: auto;
      overflow-x: hidden;
      margin-top: 20px;
    }
    .side .folders ul {
      list-style-type: disclosure-closed;
      list-style: none;
      padding-left: 15px;
      margin: 6px 0;
    }
    .side .folders > ul {
      padding-left: 0;
    }
    .side .folders ul:not(.folders > ul) {
      margin: 0;
    }
    .side .folders {
      margin-top: 2rem;
      min-height: 88vh;
    }
    .folder {
      cursor: default;
      transition: all 1s ease;
      position: relative;
      user-select: none;
    }
    .folder:hover::before {
      content: '';
      position: absolute;
      width: 1000%;
      height: 100%;
      left: -1000px;
      background: rgb(229 172 239 / 15%);
      pointer-events: none;
    }
    .folder .fa-circle-arrow-left {
      color: #9b7f98;
      cursor: pointer;
      transition: all .5s ease;
      display: none;
    }
    .folder .fa-circle-arrow-left:hover {
      color: #543e52;
    }
    .folder:hover .fa-circle-arrow-left {
      display: inline-block;
    }
    .gallery {
      display: flex;
      flex-wrap: wrap;
      height: calc(100vh - 123px);
      overflow: auto;
      margin-top: 20px;
      padding-bottom: 55px;
    }
    .gallery > div:not(.pgn) {
      display: flex;
      width: 195px;
      height: 185px;
      margin-top: 20px;
      align-items: center;
      justify-content: center;
    }
    .gallery > div > img, .gallery > div > video, .card__image img {
      max-width: 175px;
      max-height: 175px;
    }
    .animate-box.empty {
      width: 100% !important;
      display: block !important;
      font-size: 1rem;
      font-style: italic;
    }
    .animate-box.empty>div {
      padding: 0 15px;
    }
    .animate-box.empty img {
      width: 80%;
      max-width: fit-content;
      max-height: fit-content;
      margin: auto;
      display: block;
      box-shadow: 0 4px 16px 5px rgb(0 0 0 / 45%);
      margin-top: 30px;
    }
    .side > * {
      margin-top: 20px;
    }
    .side .tags ul {
      list-style-type: square;
      padding-left: 15px;
      margin: 6px 0;
      list-style-type: none;
      padding: 0;
    }
    .side .tags li {
      overflow: hidden;
    }
    .side .tag .fa-tags {
      color: #fff;
    }
    .source-checkbox {
      /* display: flex; */
      /* justify-content: center; */
      margin-left: 40px;
    }
    .source-checkbox .toggler-wrapper {
      width: 100px;
      height: 20px;
    }
    .source-checkbox .toggler-wrapper.style-2 .toggler-knob:before {
      content: 'Local';
      left: 8px;
    }
    .source-checkbox .toggler-wrapper.style-2 .toggler-knob:after {
      content: 'Gelbooru';
      right: 8px;
    }
    .source-checkbox .toggler-wrapper .toggler-slider {
      background-color: #2f3640;
    }
    .source-checkbox .toggler-wrapper input[type="checkbox"]:checked+.toggler-slider {
      background-color: #683954;
    }
    .searchBox {
      background: #2f3640;
      height: 15px;
      border-radius: 40px;
      padding: 8px;
      border: 1px solid #fff;
      width: calc(100% - 8px * 2);
    }
    .searchInput {
      border: none;
      background: none;
      outline: none;
      float: left;
      padding: 0;
      color: white;
      font-size: 12px;
      transition: 0.4s;
      line-height: 12px;
      width: calc(100% - 15px);
        padding: 0 6px;
    }
    .searchBox .fa-magnifying-glass {
      font-size: 14px;
    }
    .ui-menu {
      background: #fff;
      color: #000;
      z-index: 1;
      list-style-type: none;
      padding: 5px 0;
      margin-top: 12px;
      overflow: auto;
      max-height: 256px;
      width: calc(100vw - 60px) !important;
    }
    .ui-menu .ui-menu-item div {
      padding: 1px 12px;
      display: flex;
      justify-content: space-between;
    }
    .ui-menu .ui-menu-item .ui-state-active {
      background: #f3d6f9;
      border-left: 2px solid #a87bb1;
      border-right: 2px solid #a87bb1;
      border-top: 1px solid #e7b5f1;
      border-bottom: 1px solid #e7b5f1;
    }
    .tag-count {
      color: #bbb;
    }
    .tag-type-0, .tag-type-tag {color: #337ab7}
    .tag-type-1, .tag-type-artist {color: #A00}
    .tag-type-artist:hover {color: #9093FF}
    .tag-type-4, .tag-type-character {color: #0A0}
    .tag-type-character:hover {color: #9093FF}
    .tag-type-3, .tag-type-copyright {color: #A0A}
    .tag-type-copyright:hover {color: #9093FF}
    .tag-type-5, .tag-type-metadata {color: #F80}
    .tag-type-metadata:hover {color: #FA6}
    .tag-type-deprecated {
      color: #c0c0c0 !important;
      text-decoration: line-through;
    }
    .tag-type-deprecated:hover {
      color: #c0c0c0;
      text-decoration: line-through;
    }
    .tag-type-2 {text-decoration: line-through}
    .pagination-trigger {
      position: fixed;
      bottom: 0;
      width: calc(100% - 221px) !important;
      height: 45px !important;
      margin: 0 !important;
      z-index: 1;
    }
    .content_detail__pagination.cdp {
      margin-top: 0;
      margin-bottom: 12px;
      padding-top: 0;
    }
    .loading {
      width: 100vw !important;
      margin: 80px 0 !important;
      animation: loading-anim 500ms ease both;
    }
    @media (max-width: 850px) {
      .content {
        flex-direction: column-reverse;
      }
      .loading {
        width: 100vw !important;
        margin: 80px 0 !important;
        animation: loading-anim 500ms ease both;
      }
      .pagination-trigger {
        width: 100% !important;
      }
      .gallery > div:not(.loading):not(.pagination-trigger):not(.empty) {
        width: 32vw !important;
        min-width: unset;
        margin-top: unset !important;
        padding: 10px;
        box-sizing: border-box;
      }
      .gallery > div > img, .gallery > div > video, .card__image img {
        width: 100%;
        object-fit: contain;
        /*height: 175px;*/
        /*object-fit: cover;*/
      }
      .searchBox {
        margin: 0 8px;
        width: calc(100% - 8px * 2 * 2);
      }
    }
    @media (min-width: 950px) {
      .animate-box.empty img {
        max-width: 600px;
      }
    }
    @-webkit-keyframes fadeInUp {
      from {
        opacity: 0;
        /*-webkit-transform: translate3d(0, 100%, 0);
        transform: translate3d(0, 100%, 0);*/
        -webkit-transform: translate3d(0, 50px, 0);
        transform: translate3d(0, 50px, 0);
      }

      to {
        opacity: 1;
        -webkit-transform: none;
        transform: none;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        /*-webkit-transform: translate3d(0, 100%, 0);
        transform: translate3d(0, 100%, 0);*/
        -webkit-transform: translate3d(0, 50px, 0);
        transform: translate3d(0, 50px, 0);
      }

      to {
        opacity: 1;
        -webkit-transform: none;
        transform: none;
      }
    }
    .fadeInUp {
      -webkit-animation-name: fadeInUp;
      animation-name: fadeInUp;
    }
    .animated {
      -webkit-animation-duration: 1s;
      animation-duration: 1s;
      -webkit-animation-fill-mode: both;
      animation-fill-mode: both;
    }
    .animate-box {
      opacity: 0;
    }

    .card__image {
      //width: 375px;
      transition: all 0.5s ease;
      position: relative;
      overflow: hidden;
      background: none;
      border-radius: 7px;
    }
    .card-icons i {
      cursor: pointer;
      font-size: 18px;
      color: crimson;
      padding: 15px 10px;
      transform: translateY(100px);
      transition: all 0.5s ease;
        transition-delay: 0s;
    }
    .card-icons {
      position: absolute;
      left: 0;
      top: 38px;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      z-index: 1;
    }
    .animate-box:hover .card-icons i {
      transform: translateY(-38px);
    }
    .animate-box:hover .card-icons i.fa-heart {
      transition-delay: 0.1s;
    }
    .card__image::before {
      content: '';
      position: absolute;
      top: -200px;
      left: -200px;
      width: 500%;
      height: 500%;
      z-index: 1;
      background: #12c2e9;
      background: -webkit-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: -moz-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: -ms-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: -o-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      mix-blend-mode: multiply;
      transition: all 0.5s ease;
      border-radius: 7px;
      opacity: 0;
    }
    .animate-box:hover .card__image::before {
      opacity: 1;
      transition: all 0.5s ease;
    }
    .animate-box:hover .card__image {
      box-shadow: 10px 20px 40px rgb(0 0 0 / 35%);
    }
    @keyframes loading-anim {
      from {
        transform: scale(1.2);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    @keyframes update-effect {
      from {
        transform: scale(1.2) translateY(-38px);
      }
      to {
        transform: scale(1) translateY(-38px);
      }
    }
    .video-post-icon {
      position: absolute;
      top: calc(50% - 32px);
      left: calc(50% - 18px);
      font-size: 2.5rem;
      text-shadow: 1px 1px 4px #000;
    }
    .fa-heart.update-effect {
      animation: update-effect 500ms ease both;
    }
    .swal2-container textarea, .swal2-container input, .swal2-container label {
      font-size: .72rem;
    }
    #spotlight {
      z-index: 999;
    }
    .spl-like {
      background-image: url(icons/heart-outline.svg);
      background-size: 23px;
    }
    .spl-like.on {
      background-image: url(icons/heart.svg);
    }
    .spl-properties {
      background-image: url(icons/eye-regular.svg);
      background-size: 23px;
    }
    .swal2-html-container {
      overflow: visible;
    }
    .post-details {
      display: flex;
      font-size: 10px;
    }
    .details-preview > img {
      box-shadow: 0px 1px 3px 0px rgb(0 0 0 / 30%);
      margin-bottom: 12px;
      max-width: 90%;
      max-height: 200px;
    }
    .details-preview span {
      background: rgb(0 0 0 /17%);
      background: #cfcfcf;
      line-height: 14px;
      padding: 1px 4px;
    }
    .post-details h5 {
      font-size: 1.15rem;
      margin: 2px 0;
    }
    .post-details > div {
      width: 50%;
    }
    .post-details .statistics {
      padding-left: 5px;
    }
    .tag {
      display: block;
    }
    .tag .count {
      color: #ababab;
    }
    .side .tag {
      cursor: pointer;
      word-break: break-all;
      display: inline-block;
    }
    .side .tag .count {
      color: #9b7f98;
    }
    .tag {
      transition: all .5s ease;
    }
    .side .tag-type-0, .side .tag-type-tag {color: #d2eaff}
    .side .tag-type-0:hover, .side .tag-type-tag:hover {color: #485968}
    .side .tag-type-1, .side .tag-type-artist {color: #db4b4b}
    .side .tag-type-1:hover, .side .tag-type-artist:hover {color: #ab0707}
    .side .tag-type-4, .side .tag-type-character {color: #1fd71f}
    .side .tag-type-4:hover, .side .tag-type-character:hover {color: #0e660e}
    .side .tag-type-3, .side .tag-type-copyright {color: #fb43fb}
    .side .tag-type-3:hover, .side .tag-type-copyright:hover {color: #701d70}
    .side .tag-type-5, .side .tag-type-metadata {color: #eeff65}
    .side .tag-type-5:hover, .side .tag-type-metadata:hover {color: #4d5220}
    .side .tag-type-7, .side .tag-type-custom {color: #ffbc00}
    .side .tag-type-7:hover, .side .tag-type-custom:hover {color: #a57900}

    .edit-post-swal .directory-placeholder {
      background: #cfcfcf;
      line-height: 14px;
      padding: 1px 4px;
      min-height: 14px;
      border: 0;
      font-size: 10px;
    }
    .edit-post-swal .count {display:none}
    .edit-post-swal .tag {
      display: inline-block;
      background: #337ab7;
      color: white;
      padding: 1px 5px;
      margin: 0 2px 2px 2px;
      border-radius: 4px;
    }
    .edit-post-swal .tag-type-0, .edit-post-swal .tag-type-tag {background: #337ab7}
    .edit-post-swal .tag-type-0:hover, .edit-post-swal .tag-type-tag:hover {background: #16558b}
    .edit-post-swal .tag-type-1, .edit-post-swal .tag-type-artist {background: #A00}
    .edit-post-swal .tag-type-1:hover, .edit-post-swal .tag-type-artist:hover {background: #760101}
    .edit-post-swal .tag-type-4, .edit-post-swal .tag-type-character {background: #0A0}
    .edit-post-swal .tag-type-4:hover, .edit-post-swal .tag-type-character:hover {background: #018b01}
    .edit-post-swal .tag-type-3, .edit-post-swal .tag-type-copyright {background: #A0A}
    .edit-post-swal .tag-type-3:hover, .edit-post-swal .tag-type-copyright:hover {background: #7a007a}
    .edit-post-swal .tag-type-5, .edit-post-swal .tag-type-metadata {background: #F80}
    .edit-post-swal .tag-type-5:hover, .edit-post-swal .tag-type-metadata:hover {background: #FA6}
    .edit-post-swal .tag-type-7, .edit-post-swal .tag-type-custom {background: #add534}
    .edit-post-swal .tag-type-7:hover, .edit-post-swal .tag-type-custom:hover {background: #759907}

    .edit-post-swal .tag-type-7, .edit-post-swal .tag-type-custom {
      display: block;
      width: fit-content;
    }
    
    .edit-post-swal .folders {
      width: 100%;
    }
    .edit-post-swal .folders > ul {
      padding: 3px 6px;
      border: 1px solid #7066e0;
      height: 125px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    .edit-post-swal .folders ul {
      background: #fff;
      list-style: none;
      margin: 0;
      padding-left: 10px;
    }
    .post-edit-details {
      font-size: 10px;
    }

    .side2 .tag {
      cursor: pointer;
      position: relative;
      margin-left: 20px;
      padding: 0 6px 1px 12px;
      background: #0089e0;
      color: #fff;
      text-decoration: none;
      -moz-border-radius-bottomright: 4px;
      -webkit-border-bottom-right-radius: 4px;
      border-bottom-right-radius: 4px;
      -moz-border-radius-topright: 4px;
      -webkit-border-top-right-radius: 4px;
      border-top-right-radius: 4px;
      margin-bottom: 4px;
      word-break: break-all;
      max-width: fit-content;
    }
    .side2 .tag:before {
      content: "";
      float: left;
      position: absolute;
      top: 0px;
      left: -10px;
      width: 0;
      height: 0;
      border-color: transparent #0089e0 transparent transparent;
      border-style: solid;
      border-width: 9px 10px 9px 0px;
    }
    .side2 .tag:after {
      content: "";
      position: absolute;
      top: 8px;
      left: 0;
      float: left;
      width: 4px;
      height: 4px;
      -moz-border-radius: 2px;
      -webkit-border-radius: 2px;
      border-radius: 2px;
      background: #755773;
      /* -moz-box-shadow: -1px -1px 2px #004977; */
      /* -webkit-box-shadow: -1px -1px 2px #004977; */
      /* box-shadow: -1px -1px 2px #004977; */
    }
  </style>
</head>
<body>
  <section class="_menu draggable">
    <div>
      <span class="no-drag btn-minimize">_</span>
      <span class="no-drag btn-maximize"><i class="fa-light fa-square"></i></span>
      <span class="no-drag btn-close"><i class="fa-solid fa-xmark"></i></span>
    </div>
  </section>
  <section class="header">
    <div class="searchBox">
          <input class="searchInput" type="text" placeholder="Search | Ex: blue_sky cloud 1girl">
          <i class="fa-solid fa-magnifying-glass"></i>
      </div>
  </section>
  <section class="content">
    <div class="side">
      <div class="source-checkbox">
        <label class="toggler-wrapper style-2">
          <input type="checkbox" >
          <div class="toggler-slider">
            <div class="toggler-knob"></div>
          </div>
        </label>
      </div>
      <div class="tags placeholder-glow">
        <div><span class="placeholder col-3"></span></div>
        <ul class="placeholder-glow">
          <li><span class="placeholder col-3"></span></li>
        </ul>
      </div>
      <div class="tags placeholder-glow">
        <div><span class="placeholder col-3"></span></div>
        <ul class="placeholder-glow">
          <li>
            <span class="placeholder col-5"></span>
            <span class="placeholder col-3"></span>
          </li>
          <li>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-5"></span>
          </li>
          <li>
            <span class="placeholder col-3"></span>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-4"></span>
          </li>
          <li><span class="placeholder col-3"></span></li>
          <li>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-5"></span>
          </li>
        </ul>
      </div>
      <div class="tags placeholder-glow">
        <div><span class="placeholder col-3"></span></div>
        <ul class="placeholder-glow">
          <li>
            <span class="placeholder col-5"></span>
            <span class="placeholder col-3"></span>
          </li>
          <li>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-5"></span>
          </li>
          <li>
            <span class="placeholder col-3"></span>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-4"></span>
          </li>
        </ul>
      </div>
      <div class="tags placeholder-glow">
        <div><span class="placeholder col-3"></span></div>
        <ul class="placeholder-glow">
          <li>
            <span class="placeholder col-5"></span>
            <span class="placeholder col-3"></span>
          </li>
          <li>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-5"></span>
          </li>
          <li><span class="placeholder col-4"></span></li>
          <li>
            <span class="placeholder col-3"></span>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-4"></span>
          </li>
          <li><span class="placeholder col-5"></span></li>
          <li><span class="placeholder col-2"></span></li>
          <li><span class="placeholder col-6"></span></li>
          <li><span class="placeholder col-3"></span></li>
          <li>
            <span class="placeholder col-5"></span>
            <span class="placeholder col-3"></span>
          </li>
          <li><span class="placeholder col-6"></span></li>
          <li><span class="placeholder col-5"></span></li>
          <li><span class="placeholder col-6"></span></li>
          <li><span class="placeholder col-3"></span></li>
          <li><span class="placeholder col-2"></span></li>
          <li><span class="placeholder col-4"></span></li>
          <li><span class="placeholder col-2"></span></li>
          <li>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-5"></span>
          </li>
          <li><span class="placeholder col-3"></span></li>
          <li><span class="placeholder col-2"></span></li>
          <li>
            <span class="placeholder col-3"></span>
            <span class="placeholder col-2"></span>
            <span class="placeholder col-4"></span>
          </li>
          <li><span class="placeholder col-3"></span></li>
          <li><span class="placeholder col-2"></span></li>
        </ul>
      </div>
      <div class="tags artists">
        <div><strong>Artists:</strong></div>
        <ul></ul>
      </div>
      <div class="tags characters">
        <div><strong>Characters:</strong></div>
        <ul></ul>
      </div>
      <div class="tags copyright">
        <div><strong>Copyright:</strong></div>
        <ul></ul>
      </div>
      <div class="tags metadata">
        <div><strong>Metadata:</strong></div>
        <ul></ul>
      </div>
      <div class="tags regular">
        <div><strong>Tags:</strong></div>
        <ul></ul>
      </div>
      <div class="tags custom-tags">
        <div><strong>Custom Tags:</strong></div>
        <ul></ul>
      </div>
      <div class="folders">
        <div><strong>Folders:</strong></div>
        <ul>
          <li>
            <div class="folder"><i class="fa-solid fa-caret-down"></i> <i class="fa-solid fa-folder-open"></i> a folder</div>
            <ul>
              <li><div class="folder"><i class="fa-solid fa-caret-right"></i> <i class="fa-solid fa-folder"></i> a subfolder</div></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <div class="gallery">
      <!-- -->
    </div>
  </section>

  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  
  <script
        src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>
  
  <script
        src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"
        integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY="
        crossorigin="anonymous"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
  
  <script type="text/javascript" src="spotlight.bundle.js"></script>

  <script src="node_modules/sweetalert2/dist/sweetalert2.min.js"></script>
  
  <script type="text/javascript">
    var debug
    $(document).ready(function(){
      const ipc = require("electron").ipcRenderer      

      $('.tags.placeholder-glow').show()
      $('.tags:not(.placeholder-glow),.folders').hide()

      var settings = null
      ipc.send("settings:require")
      ipc.once("settings:view", (e, response) => {
        settings = response
        var default_source = settings.remember_last_source
        var default_tags = settings.remember_last_search

        setSourceCheckboxState(default_source)
        $('.searchInput').val(default_tags)
        ipc.send("gallery:require", null, default_tags, default_source)
        ipc.once("gallery:view", galleryDefaultView)
      })

      function galleryDefaultView(e, gallery, images) {
        $('.gallery').html('')

        if (gallery["@attributes"].count > 0)
          $.each(gallery.post, function( index, value ) {
            $('.gallery').append(buildPost(value))
          })
        else $('.gallery').html(buildEmptyGallery())

        mainTagsReload(gallery.post, ipc)

        $('.gallery').append(buildPagination(gallery))
        paginationFunctions()

        $('.card__image').before().on('click', function(e) {
          Spotlight.show(images, spotlightConfig(images, $(this), ipc))
          $('#spotlight').unbind().on('mouseleave', function (){Spotlight.menu(true)})
        })
        $('.fa-heart').on('click', {ipc: ipc}, editPostDetails)
        $('[data-bs-toggle=tooltip]').tooltip()
        displayGalleryAnimations()
        $('.content_detail__pagination a').on('click', {ipc: ipc}, clickOnPaginationButtons)
      }

      $('.source-checkbox input').on('change', function(){
        var source = getCurrentSourceCheckboxState()
        var tags = $('.searchInput').val()
        $('.gallery').html(`<div class="loading">${loading}</div>`)
        $('.tags.placeholder-glow').show()
        $('.tags:not(.placeholder-glow)').hide()
        
        ipc.send("gallery:require", null, tags, source)
        ipc.once("gallery:view", galleryDefaultView)

        ipc.send("settings:edit", 'remember_last_source', source)
        ipc.once("settings:updated", (e) => {})
      })

      $('.searchInput').on("keypress", function(e) {
        if (e.which==13) {
          var tags = $(this).val().trim()
          var source = getCurrentSourceCheckboxState()
          $('.gallery').html(`<div class="loading">${loading}</div>`)
          $('.tags.placeholder-glow').show()
          $('.tags:not(.placeholder-glow),.folders').hide()

          ipc.send("settings:edit", 'remember_last_search', tags)
          ipc.once("settings:updated", (e) => {})

          ipc.send("gallery:require", null, tags, source)
          ipc.once("gallery:view", (e, gallery, images) => {
            $('.gallery').html('')
            if (gallery["@attributes"].count > 0)
              $.each(gallery.post, function( index, value ) {
                $('.gallery').append(buildPost(value))
              })
            else $('.gallery').html(buildEmptyGallery())
            mainTagsReload(gallery.post, ipc)

            $('.gallery').append(buildPagination(gallery))
            paginationFunctions()

            $('.card__image').before().on('click', function() {
              Spotlight.show(images, spotlightConfig(images, $(this), ipc))
            })
            $('.fa-heart').on('click', {ipc: ipc}, editPostDetails)
            $('[data-bs-toggle=tooltip]').tooltip()
            displayGalleryAnimations()
            $('.content_detail__pagination a').on('click', {ipc: ipc}, clickOnPaginationButtons)
          })
        }
      })

      $('.gallery').html(`<div class="loading">${loading}</div>`)

      $('.btn-minimize').on('click', function() {
        ipc.send('minimize')
      })

      $('.btn-maximize').on('click', function() {
        ipc.send('maximize')
      })

      $('.btn-close').on('click', function() {
        ipc.send('close')
      })

      $( '.searchInput' )
      // don't navigate away from the field on tab when selecting an item
      .on( "keydown", function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB && $( this ).autocomplete( "instance" ).menu.active ) {
          event.preventDefault()
        }
        if (event.keyCode === $.ui.keyCode.ENTER && !$( this ).autocomplete( "instance" ).menu.active)
          $( this ).autocomplete( "close" )
      }).autocomplete({
        source: function( request, response ) {
          var search = request.term.split(/\s+/).pop()
          ipc.send('tags:require', search)
          ipc.once("tags:view", (e, _tags) => {
            response( _tags.tag )
          })
        },
        search: function() {
          // custom minLength
          var term = this.value.split(/\s+/).pop()
          if ( term.length == 0 ) {
            return false
          }
        },
        focus: function() {
          // prevent value inserted on focus
          return false;
        },
        select: function( event, ui ) {
          var terms = this.value.split(/\s+/)
          terms.pop()
          terms.push( ui.item.name )
          terms.push( "" );
          this.value = terms.join( " " );
          return false;
        }
      }).autocomplete( "instance" )._renderItem = function( ul, item ) {
        return $( "<li>" )
          .append( `<div><span class="tag-type-${item.type}">${item.name}</span> <span class="tag-count">${item.count}</span></div>` )
          .appendTo( ul )
      }
    })

Array.prototype.unique = function() {
    return [...new Set(this)];
}
      
function getCurrentSourceCheckboxState () {
  return $('.source-checkbox input').is(':checked') ? 'gelbooru' : 'local'
}

function setSourceCheckboxState(state) {
  if (state == 'gelbooru')
    $('.source-checkbox input').prop('checked', true)
  else if (state == 'local' || true) // default
    $('.source-checkbox input').prop('checked', false)
}

function editPostDetails(e) {
  // avoid the click on image interfiere with this
  if (!e) e = window.event
  e.stopPropagation()

  var ipc = e.data.ipc
  var post_id = $(this).closest('.animate-box').find('meta').data('id')
  ipc.send("post:require", post_id)
  ipc.once("post:response", (e, gelbooru_post, localbooru_post) => {
    var post = localbooru_post ?? gelbooru_post
    var local_directory = post.local_directory ?? "/"
    var custom_tags = post.custom_tags ?? ""

    ipc.send("tags:organize", post.tags)
    ipc.once("tags:htmlresponse", (e, _tags) => {
      var convertTagsToHtml = tag => `<span class="tag tag-type-${tag.type}">${tag.name} <span class="count">${tag.count}</span></span>`
      var artist_tags = _tags.filter(t=>t.type==1).map(convertTagsToHtml).join('')
      var character_tags = _tags.filter(t=>t.type==4).map(convertTagsToHtml).join('')
      var copyright_tags = _tags.filter(t=>t.type==3).map(convertTagsToHtml).join('')
      var metadata_tags = _tags.filter(t=>t.type==5).map(convertTagsToHtml).join('')
      var regular_tags = _tags.filter(t=>t.type==0).map(convertTagsToHtml).join('')

      var backdrops = [
        //'images/nyan-cat.gif',
        'https://img3.gelbooru.com/images/03/2e/032eeb05b1aedcf2794b9632a5e55913.gif',
        'https://img3.gelbooru.com/images/7c/34/7c3414545f58e795812e756763e4cc9b.gif',
        'https://img3.gelbooru.com/images/ce/ed/ceedab2dc3b99509c4e7c6f75b430412.gif',
        'https://img3.gelbooru.com/images/c8/9a/c89abfa2a17a44e16a8d642ff0fc3b42.gif',
        'https://img3.gelbooru.com/images/d3/a4/d3a436d24fe2319e0b85e24683a6fa2b.gif',
        'https://img3.gelbooru.com/images/df/bf/dfbfa2799d53885dbb07c7680b5dcf96.gif',
      ]
      var backdrop = backdrops[generateRandom(0, backdrops.length-1)]
      var sample_url = post.sample ? `<div>sample: <span>${post.sample_url}</span></div>` : ``

      folders.load('.edit-post-swal .folders ul', function (e) {
        if (!e) e = window.event
        e.stopPropagation()

        var route = $(this).closest('li').data('route')
        $('.directory-placeholder').val( route )
      })

      var getCustomTagsField = value => {
        var html = ""
        if (value) {
          value.split(/\s+/).forEach(tag => {
            html += `<span class="tag tag-type-7">${tag}</span>`
          })
        }
        return html
      }
      
      Swal.mixin({
        customClass: {
          container: 'edit-post-swal'
        }
      }).fire({
        //title: '<h3 class="text-left"><i class="fa-solid fa-pen-to-square"></i> Editar detalles</h3>',
        //width: 600,
        //padding: '3em',
        color: '#716add',
        background: '#fff url(images/trees.png)',
        backdrop: `
          rgba(0,0,123,0.4)
          url("${backdrop}")
          left top
          no-repeat
        `,
        html: `
              <div class="post-details">
                <div class="tags">
                  <h5>Artist</h5>
                  <div class="text-left">${artist_tags}</div>
                  <h5>Character</h5>
                  <div class="text-left">${character_tags}</div>
                  <h5>Copyright</h5>
                  <div class="text-left">${copyright_tags}</div>
                  <h5>Metadata</h5>
                  <div class="text-left">${metadata_tags}</div>
                  <h5>Tags</h5>
                  <div class="text-left">${regular_tags}</div>
                  <h5>Custom Tags</h5>
                  <div class="text-left custom-tags">${getCustomTagsField(custom_tags)}</div>
                </div>
                <div>
                  <div class="details-preview">
                    <img src="${post.preview_url}">
                    <div>file: <span>${post.file_url}</span></div> ${sample_url}
                  </div>
                  <div class="text-left">
                    <h5>Estadísticas</h5>
                    <div><strong>Id:</strong> ${post.id}</div>
                    <div><strong>Posted:</strong> ${post.created_at}</div>
                    <div><strong>Uploader:</strong> ${post.owner}</div>
                    <div><strong>Size:</strong> ${post.width}x${post.height}</div>
                    <div><strong>Rating:</strong> ${post.rating}</div>
                    <div><strong>Score:</strong> ${post.score}</div>
                  </div>
                  <div class="text-left">
                    <h5>Más información</h5>
                    <div><strong>Md5:</strong> ${post.md5}</div>
                    <div><strong>Source:</strong> ${post.source??'-'}</div>
                    <div><strong>Change:</strong> ${post.change}</div>
                    <div><strong>Parent:</strong> ${post.parent_id}</div>
                    <div><strong>Title:</strong> ${post.title.trim()??'-'}</div>
                    <div><strong>Has notes:</strong> ${post.has_notes?'Yes':'No'}</div>
                    <div><strong>Has comments:</strong> ${post.has_comments?'Yes':'No'}</div>
                    <div><strong>Has children:</strong> ${post.has_children?'Yes':'No'}</div>
                    <div><strong>status:</strong> ${post.status}</div>
                    <div><strong>Post locked:</strong> ${post.post_locked?'Yes':'No'}</div>
                  </div>
                  <div class="text-left">
                  </div>
                </div>
              </div>
              <div class="post-edit-details text-left">
                <h5>Detalles para editar</h5>
                <div class="input-group mb-3">
                  <label for="custom-tags" class="form-label col-12 text-left">Custom Tags:</label>
                  <input type="text" class="form-control col-12" id="custom-tags" placeholder="Etiquetas Personalizadas" value="${custom_tags??""}">
                </div>
                <div class="input-group mb-3">
                  <label for="local_directory" class="form-label col-12 text-left">Directorio Local:</label>
                  <input class="form-label col-12 directory-placeholder" id="local_directory" placeholder="/" value="${local_directory}">
                  <div class="folders">
                    <div><strong>Folders:</strong></div>
                    <ul></ul>
                  </div>
                </div>
              </div>
        `,
        didOpen: () => {
          SetCaretAtEnd(document.getElementById('custom-tags'))
          $('#custom-tags').on('input', function() {
            $(this).closest('.swal2-html-container').find('.custom-tags').html("")
            $('.edit-post-swal .custom-tags').append(getCustomTagsField($(this).val().trim()))
          })
        },
        showConfirmButton: true,
        confirmButtonText: '<i class="fa-solid fa-heart"></i> Guardar favorito',
        showCancelButton: true,
        cancelButtonText: '<i class="fa-solid fa-rectangle-xmark"></i> Cancelar',
        showDenyButton: post.favorite?true:false,
        denyButtonText: `<i class="fa-solid fa-heart-crack"></i> Quitar de favoritos`,
      }).then((result) => {
        var custom_tags = $('#custom-tags').val(),
            local_directory = $('.directory-placeholder').val()
        if (result.isConfirmed) {
          ipc.send("post:edit", post_id, custom_tags, local_directory, 1)
          ipc.once("post:updated", (e) => {
            Swal.fire('¡Post guardado en favoritos!', '', 'success')
            folders.load('.side .folders>ul', selectFolder)
            $(this).tooltip('dispose').removeClass('fa-regular').addClass('fa-solid').attr('title', 'Editar favorito').tooltip()
            if ($('#spotlight').length>0)
              $('#spotlight').find('.spl-like').addClass("on")
            $(this).closest('.animate-box').find('meta').data('favorite', 1)
            $(this).closest('.animate-box').find('meta').data('local_directory', local_directory)
            $(this).closest('.animate-box').find('meta').data('custom_tags', custom_tags)
          })
        } else if (result.isDenied) {
          ipc.send("post:edit", post_id, custom_tags.trim(), local_directory.trim(), 0)
          ipc.once("post:updated", (e) => {
            Swal.fire('Post removido de favoritos', 'El post fue removido de favoritos pero toda su información adicional sigue almancenada en la base de datos.', 'info')
            folders.load('.side .folders>ul', selectFolder)
            $(this).tooltip('dispose').removeClass('fa-solid').addClass('fa-regular').attr('title', 'Agregar a favoritos').tooltip()
            if ($('#spotlight').length>0)
              $('#spotlight').find('.spl-like').removeClass("on")
            $(this).closest('.animate-box').find('meta').data('favorite', 0)
            $(this).closest('.animate-box').find('meta').data('local_directory', '')
            $(this).closest('.animate-box').find('meta').data('custom_tags', '')
          })
        }
        $('body').unbind() // Detaching spotlight mousewheel event

        if(result.isConfirmed || result.isDenied) {
          ipc.send("custom-tags:reload", custom_tags.trim())
          ipc.once("custom-tags:updated", (e) => {})
        }
      })
    })
  })
}

function clickOnPaginationButtons(e) {
  var ipc = e.data.ipc
  var tags = $('.searchInput').val()
  var page = $('.content_detail__pagination').attr('actpage') - 1
  var source = getCurrentSourceCheckboxState()
  var href = $(this).attr('href')
  if (/[-+]1/.test(href)) {
    page = /-1/.test(href) ? page - 1 : page + 1
  } else page = href.match(/\d+/)[0]
  $('.gallery').append(`<div class="loading">${loading}</div>`)
  $('.animate-box').remove()

  ipc.send("gallery:require", page, tags, source)
  ipc.once("gallery:view", (e, gallery, images) => {
    $('.loading').remove()
    $.each(gallery.post, function( index, value ) {
      $('.pagination-trigger').before(buildPost(value))
    })

    $('.card__image').before().on('click', function() {
      Spotlight.show(images, spotlightConfig(images, $(this), ipc))
    })
    $('.fa-heart').on('click', {ipc: ipc}, editPostDetails)
    $('[data-bs-toggle=tooltip]').tooltip()

    displayGalleryAnimations()
  })
}

function mainTagsReload(posts, ipc) {
  if (posts && posts.length >= 2) {
    ipc.send("tags:organize", posts[0].tags.split(' ').concat(posts[1].tags.split(' ')).sort().unique().join(' '))
  } else if (posts && posts.length == 1) {
    ipc.send("tags:organize", posts[0].tags)
  } else {
    $('.tags.placeholder-glow').hide()
    $('.tags.regular ul').html('')
    $('.tags.regular').show()
    $('.folders').show()
  }

  ipc.once("tags:htmlresponse", (e, _tags) => {
    var convertTagsToHtml = tag => `<li><span class="tag tag-type-${tag.type}" style="display:none"><i class="fa-solid fa-tags"></i> ${tag.name} <span class="count">${tag.count}</span></span></li>`
    var artist_tags = _tags.filter(t=>t.type==1).map(convertTagsToHtml).join('')
    var character_tags = _tags.filter(t=>t.type==4).map(convertTagsToHtml).join('')
    var copyright_tags = _tags.filter(t=>t.type==3).map(convertTagsToHtml).join('')
    var metadata_tags = _tags.filter(t=>t.type==5).map(convertTagsToHtml).join('')
    var regular_tags = _tags.filter(t=>t.type==0).map(convertTagsToHtml).join('')
    var custom_tags = _tags.filter(t=>t.type==7).map(convertTagsToHtml).join('')
    artist_tags ? $('.tags.artists ul').html(artist_tags) : $('.tags.artists').hide()
    character_tags ? $('.tags.characters ul').html(character_tags) : $('.tags.characters').hide()
    copyright_tags ? $('.tags.copyright ul').html(copyright_tags) : $('.tags.copyright').hide()
    metadata_tags ? $('.tags.metadata ul').html(metadata_tags) : $('.tags.metadata').hide()
    regular_tags ? $('.tags.regular ul').html(regular_tags) : $('.tags.regular').hide()
    custom_tags ? $('.tags.custom-tags ul').html(custom_tags) : $('.tags.custom-tags').hide()
    $('.tags.placeholder-glow').hide()
    displaySideBarAnimations() // $('.tags:not(.placeholder-glow)').show()

    $('.side .tag').on('click', sideTagClick)
  })
}

function displaySideBarAnimations() {
  $('.tags:not(.placeholder-glow)').show()
  $('.side .tag').addClass('animate__fadeInDown animated').show()
  $('.folders').show()
}

function sideTagClick() {
  var prefix = $(this).hasClass('tag-type-7') ? '_' : ''
  var tag = prefix + $(this).text().trim().split(/\s+/)[0]
  var search = $('.searchInput').val().trim().split(/\s+/).filter(i => i!=tag)
  search.push(tag)
  $('.searchInput').val(search.join(' ')).focus()
}

const loading = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin:auto;display:block;" width="200px" height="200px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
<clipPath id="cp">
  <path d="M0 -40.5 A40.5 40.5 0 0 1 0 40.5 A40.5 40.5 0 0 1 0 -40.5 M23.5 -1L23.5 1L30.5 1L30.5 -1Z"></path>
</clipPath>
<g transform="translate(50,50)">
<circle clip-path="url(#cp)" cx="0" cy="0" fill="none" r="26" stroke="#abbd81" stroke-width="5" stroke-dasharray="40.840704496667314 0 0 0 0 163.36281798666926">
<animate attributeName="stroke-dasharray" dur="1s" repeatCount="indefinite" begin="-0.1s" keyTimes="0;0.2;0.4;0.6;0.8;1" values="
0 0 0 0 0 163.36281798666926;
0 0 0 0 0 163.36281798666926;
0 0 81.68140899333463 0 0 163.36281798666926;
0 0 163.36281798666926 0 0 163.36281798666926;
0 0 81.68140899333463 0 0 163.36281798666926;
0 0 0 0 0 163.36281798666926
"></animate>
<animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" begin="-0.1s" values="0;0;0;0;180;360"></animateTransform>
</circle>

<circle cx="0" cy="0" fill="none" r="32" stroke="#f8b26a" stroke-width="5" stroke-dasharray="100.53096491487338 0 0 201.06192982974676">
<animate attributeName="stroke-dasharray" dur="1s" repeatCount="indefinite" begin="0s" values="
0 0 0 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 0 0 0 201.06192982974676
"></animate>
<animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" begin="0s" values="0;0;0;180;180;360"></animateTransform>
</circle>

<circle cx="0" cy="0" fill="none" r="38" stroke="#e15b64" stroke-width="5" stroke-dasharray="119.38052083641213 0 0 238.76104167282426" transform="rotate(45)">
<animate attributeName="stroke-dasharray" dur="1s" repeatCount="indefinite" begin="0s" keyTimes="0;0.06;0.1;0.3;0.45;0.5;0.7;0.90;1" values="
0 0 89.5353906273091 0 0 238.76104167282426;
0 0 89.5353906273091 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 29.845130209103033 0 0 238.76104167282426;
0 0 29.845130209103033 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 89.5353906273091 0 0 238.76104167282426
"></animate>
<animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" begin="0s" keyTimes="0;0.06;0.1;0.3;0.5;0.6;0.8;0.90;1" values="-60;0;0;0;180;180;180;180;300"></animateTransform>
</circle>
</g>
</svg>`

function displayGalleryAnimations() {
  var next = 0
  var myInterval = setInterval(function () {
    if (next == $('.animate-box').length) {
      clearInterval(myInterval)
    } else {
      $($('.animate-box')[next++]).addClass('fadeInUp animated')
    }
  }, 50);
}

function paginationFunctions() {
  // source: https://codepen.io/jsnanigans/full/dXAYBJ
  var paginationPage = parseInt($('.cdp').attr('actpage'), 10);
  $('.cdp_i').on('click', function(){
    var go = $(this).attr('href').replace('#!', '');
    if (go === '+1') {
      paginationPage++;
    } else if (go === '-1') {
      paginationPage--;
    }else{
      paginationPage = parseInt(go, 10);
    }
    $('.cdp').attr('actpage', paginationPage);
  });
}

function buildPost(post) {
  var is_video = /\.(webm|mp4)$/.test(post.file_url)
  var video_post_icon = `<div class="video-post-icon"><i class="fa-regular fa-circle-play"></i></div>`
  var is_gif = /\.gif$/.test(post.file_url)
  var gif_post_icon = `<div class="video-post-icon"><i class="fa-solid fa-photo-film"></i></div>`
  var post_icon = null, post_source = null
  
  var image = post.sample_url ? post.sample_url : post.file_url

  if (is_video) {
    post_icon_html = video_post_icon
    post_source = `data-src-mp4="${post.file_url}" data-src-webm="https://img3.gelbooru.com/images/${post.directory}/${post.image}" data-poster="${post.preview_url}"`
  }
  else if (is_gif) {
    post_icon_html = gif_post_icon
    post_source = `href="${image}"`
  }
  else {
    post_icon_html = ""
    post_source = `href="${image}"`
  }

  return `<div class="animate-box">
            <div class="card__image">
              <a class="spotlight" ${post_source}>
                <img class="card__img" src="${post.preview_url}">
              </a>
              <div class="card__content">
                ${post_icon_html}
                <div class="card-icons">
                  <i class="fa-regular ${post.favorite?'fa-solid fa-heart':'fa-regular fa-heart'}" data-bs-toggle="tooltip" title="${post.favorite?'Editar favorito':'Agregar a favoritos'}"></i>
                </div>
              </div>
            </div>
            <meta data-id="${post.id}" data-created_at="${post.created_at}" data-score="${post.score}" data-width="${post.width}" data-height="${post.height}" data-md5="${post.md5}" data-directory="${post.directory}" data-image="${post.image}" data-rating="${post.rating}" data-source="${post.source}" data-change="${post.change}" data-owner="${post.owner}" data-creator_id="${post.creator_id}" data-parent_id="${post.parent_id}" data-sample="${post.sample}" data-preview_height="${post.preview_height}" data-preview_width="${post.preview_width}" data-tags="${post.tags}" data-title="${post.title}" data-has_notes="${post.has_notes}" data-has_comments="${post.has_comments}" data-file_url="${post.file_url}" data-preview_url="${post.preview_url}" data-sample_url="${post.sample_url}" data-sample_height="${post.sample_height}" data-sample_width="${post.sample_width}" data-status="${post.status}" data-post_locked="${post.post_locked}" data-has_children="${post.has_children}" data-local_directory="${post.local_directory}" data-custom_tags="${post.custom_tags}" data-favorite="${post.favorite}" />
          </div>`
}

function buildEmptyGallery() {
  var banners = [
    'images/cd4Y1C1g.jpg',
    'images/i-cant-understand-what-my-husband-is-saying-danna-ga-nani-o-itteiru-ka-wakaranai-ken-kaoru-hajime.jpg',
  ]
  var banner = banners[generateRandom(0, banners.length-1)]
  return `<div class="animate-box empty fadeInUp animated"><div>No ha sido encontrado ningún post que coincida con el criterio de búsqueda.</div><img src="${banner}"></div>`
}

// Source:  https://codepen.io/jsnanigans/full/dXAYBJ
function buildPagination(gallery) {
  var count = gallery["@attributes"].count
  var limit = gallery["@attributes"].limit ?? 9999999
  var offset = gallery["@attributes"].offset

  pages = Math.ceil(count / limit)

  if (pages <= 1)
    return ''
  else if (pages > 500)
    pages = 500

  var pages_html = ""
  for (var i=1; i<=pages; i++) {
    pages_html += `<a href="#!${i}" class="cdp_i">${i}</a>`
  }

  return `<div class="pagination-trigger">
            <div class="content_detail__pagination cdp" actpage="1">
              <a href="#!-1" class="cdp_i">prev</a>
              ${pages_html}
              <a href="#!+1" class="cdp_i">next</a>
            </div>
          </div>`
}

// Spotlight:   https://github.com/nextapps-de/spotlight
function spotlightConfig(gallery, $this, ipc) {
  var clicked_index = $this.closest('.animate-box').index() + 1
  var tags = $this.closest('.animate-box').find('meta').data('tags')
  var config = {
    animation: 'fade',
    control: ['prev', 'next', 'download', 'play', 'theme', 'zoom', 'autofit', 'close'],
    infinite: true,
    autohide: 'all',
    //title: 'LocalBooru Gallery',
    spinner: true,
    index: clicked_index,
    //autoslide: true,
    //progress: false,
    onshow: function(index){ // fires when gallery opens
      $('._menu').removeClass('draggable')

      // the method "addControl" returns the new created control element
      like = Spotlight.addControl("like", function() {
        $('body').on('mousewheel', function () {Spotlight.zoom(1)})
        $($('.animate-box')[slide]).find('.fa-heart').click()
      })
      properties = Spotlight.addControl("properties", function() {
        var props = ['id','post_id','created_at','score','width','height','md5','directory','image','rating','source','change','owner','creator_id','parent_id','sample','preview_height','preview_width','tags','title','has_notes','has_comments','file_url','preview_url','sample_url','sample_height','sample_width','status','post_locked','has_children','local_directory','custom_tags','favorite']
        var post = {}

        props.forEach(prop => {
          post[prop] = $($('.animate-box')[slide]).find('meta').data(prop)
        })
        console.log(post)

        ipc.send("tags:organize", post.tags, post.custom_tags)
        ipc.once("tags:htmlresponse", (e, _tags) => {

          Spotlight.zoom(1)
          $('body').on('mousewheel', function () {Spotlight.zoom(1)})

          var convertTagsToHtml = tag => `<span class="tag tag-type-${tag.type}">${tag.name} <span class="count">${tag.count}</span></span>`
          var artist_tags = _tags.filter(t=>t.type==1).map(convertTagsToHtml).join('')
          var character_tags = _tags.filter(t=>t.type==4).map(convertTagsToHtml).join('')
          var copyright_tags = _tags.filter(t=>t.type==3).map(convertTagsToHtml).join('')
          var metadata_tags = _tags.filter(t=>t.type==5).map(convertTagsToHtml).join('')
          var regular_tags = _tags.filter(t=>t.type==0).map(convertTagsToHtml).join('')
          var custom_tags = _tags.filter(t=>t.type==7).map(convertTagsToHtml).join('')

          var sample_url = post.sample ? `<div>sample: <span>${post.sample_url}</span></div>` : ``

          Swal.fire({
            background: '#fff url(images/trees.png)',
            html: `
              <div class="post-details">
                <div class="tags">
                  <h5 class="artists">Artist</h5>
                  <div class="artists text-left">${artist_tags}</div>
                  <h5 class="characters">Character</h5>
                  <div class="characters text-left">${character_tags}</div>
                  <h5 class="copyright">Copyright</h5>
                  <div class="copyright text-left">${copyright_tags}</div>
                  <h5 class="metadata">Metadata</h5>
                  <div class="metadata text-left">${metadata_tags}</div>
                  <h5 class="regular">Tags</h5>
                  <div class="regular text-left">${regular_tags}</div>
                  <h5 class="custom-tags">Custom Tags</h5>
                  <div class="custom-tags text-left">${custom_tags}</div>
                </div>
                <div>
                  <div class="details-preview">
                    <img src="${post.preview_url}">
                    <div>file: <span>${post.file_url}</span></div> ${sample_url}
                  </div>
                  <div class="text-left">
                    <h5>Estadísticas</h5>
                    <div><strong>Id:</strong> ${post.id}</div>
                    <div><strong>Posted:</strong> ${post.created_at}</div>
                    <div><strong>Uploader:</strong> ${post.owner}</div>
                    <div><strong>Size:</strong> ${post.width}x${post.height}</div>
                    <div><strong>Rating:</strong> ${post.rating}</div>
                    <div><strong>Score:</strong> ${post.score}</div>
                  </div>
                  <div class="text-left">
                    <h5>Más información</h5>
                    <div><strong>Md5:</strong> ${post.md5}</div>
                    <div><strong>Source:</strong> ${post.source??'-'}</div>
                    <div><strong>Change:</strong> ${post.change}</div>
                    <div><strong>Parent:</strong> ${post.parent_id}</div>
                    <div><strong>Title:</strong> ${post.title.trim()??'-'}</div>
                    <div><strong>Has notes:</strong> ${post.has_notes?'Yes':'No'}</div>
                    <div><strong>Has comments:</strong> ${post.has_comments?'Yes':'No'}</div>
                    <div><strong>Has children:</strong> ${post.has_children?'Yes':'No'}</div>
                    <div><strong>status:</strong> ${post.status}</div>
                    <div><strong>Post locked:</strong> ${post.post_locked?'Yes':'No'}</div>
                  </div>
                </div>
              </div>
            `,
            didOpen: () => {
              artist_tags ? $('.post-details .artists').show() : $('.post-details .artists').hide()
              character_tags ? $('.post-details .characters').show() : $('.post-details .characters').hide()
              copyright_tags ? $('.post-details .copyright').show() : $('.post-details .copyright').hide()
              metadata_tags ? $('.post-details .metadata').show() : $('.post-details .metadata').hide()
              regular_tags ? $('.post-details .regular').show() : $('.post-details .regular').hide()
              custom_tags ? $('.post-details .custom-tags').show() : $('.post-details .custom-tags').hide()
            },
          }).then((result) => {
            $('body').unbind()
          })
        })
      })
    },
    // fires when gallery change to another page
    onchange: function(index, options){

        // store the current index for the button listener
        // the slide index start from 1 (as "page 1")
        slide = index - 1;

        // initially apply the stored like state when slide is openened
        // at this point we use the stored like element
        gallery[slide].like = $($('.animate-box')[slide]).find('meta').data('favorite')
        like.classList.toggle("on", gallery[slide].like);
    },
    onclose: function(index){ // fires when gallery is requested to close
      $('._menu').addClass('draggable')

      // remove the custom button, so you are able
      // to open next gallery without this custom control
      Spotlight.removeControl("like")
      Spotlight.removeControl("properties")
    },
  }
  return config
}

function generateRandom(min, max) {
  let difference = max - min + 1;
  let rand = Math.random();
  rand = Math.floor( rand * difference);
  rand = rand + min;
  return rand;
}

var folders = {}

folders.get = route => {
  if (!route.endsWith('/'))
    route += '/'
  var regex = new RegExp(`^${route}([^\/]+)`) 
  return folders.root.filter(a=>a.match(regex))
    .map(a=>a.match(regex)[1])
    .unique()
}

folders.subfolders = (route, name) => `
<li data-route="${route}">
  <div class="folder">
    <i class="fa-solid fa-caret-right"></i> <i class="fa-solid fa-folder"></i> ${name} <i class="fa-solid fa-circle-arrow-left" data-bs-toggle="tooltip" title="Seleccionar carpeta"></i>
  </div>
</li>`

folders.build = (selector, selectFolderCallback) => {
  $(selector).html('')
  folders.get('/').forEach(folder => {
    $(selector).append( folders.subfolders(`/${folder}`, folder) )
  })
  $(selector).find('.folder').on('click', {selectFolderCallback: selectFolderCallback}, folderClick)
  $(selector).find('.fa-circle-arrow-left').on('click', selectFolderCallback)
}

function folderClick(e) {
  if ($(this).closest('li').find('ul').length == 0)
  {
    $(this).find('.fa-caret-right').removeClass('fa-caret-right').addClass('fa-caret-down')
    $(this).find('.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
    var route = $(this).closest('li').data('route')
    $(this).closest('li').append( '<ul></ul>' )
    folders.get(route).forEach(folder => {
      $(this).closest('li').find('ul').append( folders.subfolders(`${route}/${folder}`, folder) )
    })
    $(this).closest('.folders').find('.folder').unbind().on('click', {selectFolderCallback: e.data.selectFolderCallback}, folderClick)
    $(this).closest('.folders').find('.fa-circle-arrow-left').unbind().on('click', e.data.selectFolderCallback).tooltip()
  }
  else
  {
    $(this).find('.fa-caret-down').removeClass('fa-caret-down').addClass('fa-caret-right')
    $(this).find('.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
    $(this).closest('li').find('ul').remove()
  }
}

folders.load = (selector, selectFolderCallback) => {
  const ipc = require("electron").ipcRenderer      
  ipc.send("folders:require")
  ipc.once("folders:view", (e, _folders) => {
    folders.root = _folders
    folders.build(selector, selectFolderCallback)
  })
}

function selectFolder(e) {
  if (!e) e = window.event
  e.stopPropagation()

  var route = $(this).closest('li').data('route')
  var encoded_route = encodeURI(route)
  var search = $('.searchInput').val().trim().split(/\s+/).filter(tag=>/^(?!!?folder\:)/.test(tag))
  search.push(`folder:${encoded_route}`)
  $('.searchInput').val(search.join(' ')).focus()
}

folders.load('.side .folders>ul', selectFolder)

function SetCaretAtEnd(elem) {
  var elemLen = elem.value.length;
  if (elem.selectionStart || elem.selectionStart == '0') {
    elem.selectionStart = elemLen;
    elem.selectionEnd = elemLen;
    elem.focus();
  }
}
  </script>
</body>
</html>