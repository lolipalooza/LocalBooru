<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My App Layout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  
  <link rel="stylesheet" type="text/css" href="pagination.css">
  <style type="text/css">
    section, div {
      box-sizing: content-box;
    }
    body{
      font-family: verdana, sans-serif, helvetica;
      font-size: .71em;
      background: url(https://static.vecteezy.com/system/resources/previews/001/409/192/original/abstract-geometric-banner-free-vector.jpg) fixed;
      box-shadow: inset 0 0 0 1000px rgba(113, 25, 50, 0.65);
      margin: 0;
      padding: 0;
      color: #fff;
      overflow: hidden;
    }
    ._menu {
      position: fixed;
      top: 0;
      width: calc(100vw - 20px);
      height: 24px;
      background: #2f3640;
      -webkit-user-select: none;
      -webkit-app-region: drag;
      display: flex;
      padding: 0px 10px;
      align-items: center;
      justify-content: end;
    }
    ._menu .no-drag {
      -webkit-app-region: no-drag;
    }
    ._menu > div > span {
      padding: 0 4px;
      text-shadow: 1px 1px 0 rgb(0 0 0 / 85%);
      transition: all 1s ease;
    }
    ._menu > div > span:hover {
      color: #c8e71f;
      opacity: 1;
    }
    .btn-close {
      background: none;
      color: #fff;
      opacity: 1;
    }
    .header {
      position: fixed;
      top: 30px;
      width: calc(100% - 12px * 2);
      z-index: 1;
      padding: 0px 12px;
    }
    .content {
      display: flex;
      padding: 48px 0;
    }
    .side {
      padding-left: 12px;
      flex-basis: 12rem;
      flex-grow: 0;
      flex-shrink: 0;
    }
    .side .folders ul {
      list-style-type: disclosure-closed;
      padding-left: 15px;
      margin: 6px 0;
    }
    .side .folders ul:not(.folders > ul) {
      margin: 0;
    }
    .gallery {
      display: flex;
      flex-wrap: wrap;
      height: calc(100vh - 68px);
      overflow: auto;
      margin-top: 20px;
    }
    .gallery > div:not(.pgn) {
      display: flex;
      width: 195px;
      height: 185px;
      margin-top: 20px;
      align-items: center;
      justify-content: center;
    }
    .gallery > div > img, .gallery > div > video, .card__image img {
      max-width: 175px;
      max-height: 175px;
    }
    .side > * {
      margin-top: 20px;
    }
    .side .tags ul {
      list-style-type: square;
      padding-left: 15px;
      margin: 6px 0;
    }
    .searchBox {
      background: #2f3640;
      height: 15px;
      border-radius: 40px;
      padding: 8px;
      border: 1px solid #fff;
      width: calc(100% - 8px * 2);
    }
    .searchInput {
      border: none;
      background: none;
      outline: none;
      float: left;
      padding: 0;
      color: white;
      font-size: 12px;
      transition: 0.4s;
      line-height: 12px;
      width: calc(100% - 15px);
        padding: 0 6px;
    }
    .ui-menu {
      background: #fff;
      color: #000;
      z-index: 1;
      list-style-type: none;
      padding: 5px 0;
      margin-top: 12px;
      overflow: auto;
      max-height: 256px;
      width: calc(100vw - 60px) !important;
    }
    .ui-menu .ui-menu-item {
      padding: 1px 12px;
      display: flex;
      justify-content: space-between;
    }
    .ui-menu .ui-menu-item:hover {
      background: #f3d6f9;
      border-left: 2px solid #a87bb1;
      border-right: 2px solid #a87bb1;
      border-top: 1px solid #e7b5f1;
      border-bottom: 1px solid #e7b5f1;
    }
    .tag-count {
      color: #bbb;
    }
    .tag-type-0, .tag-type-tag > a, a.tag-type-tag {color: #337ab7}
    .tag-type-1, .tag-type-artist > a, a.tag-type-artist {color: #A00}
    .tag-type-artist > a:hover {color: #9093FF}
    .tag-type-4, .tag-type-character > a, a.tag-type-character  {color: #0A0}
    .tag-type-character > a:hover {color: #9093FF}
    .tag-type-3, .tag-type-copyright > a, a.tag-type-copyright  {color: #A0A}
    .tag-type-copyright > a:hover {color: #9093FF}
    .tag-type-5, .tag-type-metadata > a, a.tag-type-metadata  {color: #F80}
    .tag-type-metadata > a:hover {color: #FA6}
    .tag-type-deprecated > a, a.tag-type-deprecated  {
      color: #c0c0c0 !important;
      text-decoration: line-through;
    }
    .tag-type-deprecated > a:hover {
      color: #c0c0c0;
      text-decoration: line-through;
    }
    .tag-type-2 {text-decoration: line-through}
    .pagination-trigger {
      position: fixed;
      bottom: 0;
      width: calc(100% - 221px) !important;
      height: 45px !important;
      margin: 0 !important;
      z-index: 1;
    }
    .content_detail__pagination.cdp {
      margin-top: 0;
    }
    .loading {
      width: 100vw !important;
      margin: 80px 0 !important;
      animation: loading-anim 500ms ease both;
    }
    @media (max-width: 850px) {
      .content {
        flex-direction: column-reverse;
      }
      .loading {
        width: 100vw !important;
        margin: 80px 0 !important;
        animation: loading-anim 500ms ease both;
      }
      .pagination-trigger {
        width: 100% !important;
      }
      .gallery > div:not(.loading):not(.pagination-trigger) {
        width: 32vw !important;
        min-width: unset;
        margin-top: unset !important;
        padding: 10px;
        box-sizing: border-box;
      }
      .gallery > div > img, .gallery > div > video, .card__image img {
        width: 100%;
        object-fit: contain;
        /*height: 175px;*/
        /*object-fit: cover;*/
      }
      .searchBox {
        margin: 0 8px;
        width: calc(100% - 8px * 2 * 2);
      }
    }
    @-webkit-keyframes fadeInUp {
      from {
        opacity: 0;
        /*-webkit-transform: translate3d(0, 100%, 0);
        transform: translate3d(0, 100%, 0);*/
        -webkit-transform: translate3d(0, 50px, 0);
        transform: translate3d(0, 50px, 0);
      }

      to {
        opacity: 1;
        -webkit-transform: none;
        transform: none;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        /*-webkit-transform: translate3d(0, 100%, 0);
        transform: translate3d(0, 100%, 0);*/
        -webkit-transform: translate3d(0, 50px, 0);
        transform: translate3d(0, 50px, 0);
      }

      to {
        opacity: 1;
        -webkit-transform: none;
        transform: none;
      }
    }
    .fadeInUp {
      -webkit-animation-name: fadeInUp;
      animation-name: fadeInUp;
    }
    .animated {
      -webkit-animation-duration: 1s;
      animation-duration: 1s;
      -webkit-animation-fill-mode: both;
      animation-fill-mode: both;
    }
    .animate-box {
      opacity: 0;
    }

    .card__image {
      //width: 375px;
      transition: all 0.5s ease;
      position: relative;
      overflow: hidden;
      background: none;
      border-radius: 7px;
    }
    .card-icons i {
      cursor: pointer;
      font-size: 18px;
      color: crimson;
      padding: 15px 10px;
      transform: translateY(100px);
      transition: all 0.5s ease;
        transition-delay: 0s;
    }
    .card-icons {
      position: absolute;
      left: 0;
      top: 38px;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      z-index: 1;
    }
    .animate-box:hover .card-icons i {
      transform: translateY(-38px);
    }
    .animate-box:hover .card-icons i.fa-heart {
      transition-delay: 0.1s;
    }
    .card__image::before {
      content: '';
      position: absolute;
      top: -200px;
      left: -200px;
      width: 500%;
      height: 500%;
      z-index: 1;
      background: #12c2e9;
      background: -webkit-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: -moz-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: -ms-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: -o-linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      background: linear-gradient(to bottom, #f64f59, #c471ed, #12c2e9);
      mix-blend-mode: multiply;
      transition: all 0.5s ease;
      border-radius: 7px;
      opacity: 0;
    }
    .animate-box:hover .card__image::before {
      opacity: 1;
      transition: all 0.5s ease;
      box-shadow: 10px 20px 40px #000;
    }
    @keyframes loading-anim {
      from {
        transform: scale(1.2);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    .video-post-icon {
      position: absolute;
      top: calc(50% - 32px);
      left: calc(50% - 18px);
      font-size: 2.5rem;
      text-shadow: 1px 1px 4px #000;
    }
  </style>
</head>
<body>
  <section class="_menu">
    <div>
      <span class="no-drag btn-minimize">_</span>
      <span class="no-drag btn-maximize"><i class="fa-light fa-square"></i></span>
      <span class="no-drag btn-close"><i class="fa-solid fa-xmark"></i></span>
    </div>
  </section>
  <section class="header">
    <div class="searchBox">
          <input class="searchInput" type="text" placeholder="Search | Ex: blue_sky cloud 1girl">
          <i class="fa-solid fa-magnifying-glass"></i>
      </div>
  </section>
  <section class="content">
    <div class="side">
      <div class="tags">
        <div><strong>Artists:</strong></div>
        <ul>
          <li>artist</li>
        </ul>
      </div>
      <div class="tags">
        <div><strong>Characters:</strong></div>
        <ul>
          <li>satanichia kurumizawa mcdowell</li>
          <li>jeanne d'arc (fate series)</li>
          <li>jeanne d'arc (alter) (fate series)</li>
          <li>hanakoganei hibari</li>
          <li>kaname madoka</li>
          <li>sioux province</li>
          <li>illyasviel von einzbern (fate kaleid)</li>
          <li>matoi ryuuko</li>
          <li>kamado nezuko</li>
        </ul>
      </div>
      <div class="tags">
        <div><strong>Tags:</strong></div>
        <ul>
          <li>1 girl</li>
          <li>2 girls</li>
          <li>1 boy</li>
          <li>blowjob</li>
          <li>yuri</li>
          <li>legs crossed</li>
          <li>nude</li>
          <li>bikini</li>
          <li>bridal dress</li>
          <li>high heels</li>
          <li>implied fellatio</li>
          <li>implied sex</li>
          <li>sex</li>
          <li>bukkake</li>
          <li>loli</li>
          <li>big breasts</li>
        </ul>
      </div>
      <div class="folders">
        <div><strong>Folders:</strong></div>
        <ul>
          <li>
            Monas chinas
            <ul>
              <li>a</li>
              <li>b</li>
              <li>c</li>
            </ul>
          </li>
          <li>
            Ecchi
            <ul>
              <li>a</li>
              <li>b</li>
            </ul>
          </li>
          <li>
            Hentai
            <ul>
              <li>a</li>
              <li>b</li>
              <li>c</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <div class="gallery">
      <!-- -->
    </div>
  </section>

  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  
  <script
        src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>
  
  <script
        src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"
        integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY="
        crossorigin="anonymous"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
  
  <script type="text/javascript" src="spotlight.bundle.js"></script>
  
  <script type="text/javascript">
    $(document).ready(function(){
      const ipc = require("electron").ipcRenderer
      
      ipc.send("gallery:require")
      ipc.once("gallery:view", (e, gallery, images) => {
        $('.gallery').html('')
        $.each(gallery.post, function( index, value ) {
          $('.gallery').append(buildPost(value))
        })

        $('.gallery').append(buildPagination(gallery))
        paginationFunctions()

        $('.fa-eye').on('click', function() {
          Spotlight.show(images, spotlightConfig($(this)))
        })
        $('[data-bs-toggle=tooltip]').tooltip()
        displayGalleryAnimations()
        $('.content_detail__pagination a').on('click', {ipc: ipc}, clickOnPaginationButtons)
      })

      $('.searchInput').on("keypress", function(e) {
        if (e.which==13) {
          var tags = $(this).val()
          $('.gallery').html(`<div class="loading">${loading}</div>`)

          ipc.send("gallery:require", null, tags)
          ipc.once("gallery:view", (e, gallery, images) => {
            $('.gallery').html('')
            $.each(gallery.post, function( index, value ) {
              $('.gallery').append(buildPost(value))
            })

            $('.gallery').append(buildPagination(gallery))
            paginationFunctions()

            $('.fa-eye').on('click', function() {
              Spotlight.show(images, spotlightConfig($(this)))
            })
            $('[data-bs-toggle=tooltip]').tooltip()
            displayGalleryAnimations()
            $('.content_detail__pagination a').on('click', {ipc: ipc}, clickOnPaginationButtons)
          })
        }
      })

      $('.gallery').html(`<div class="loading">${loading}</div>`)

      $('.btn-minimize').on('click', function() {
        ipc.send('minimize')
      })

      $('.btn-maximize').on('click', function() {
        ipc.send('maximize')
      })

      $('.btn-close').on('click', function() {
        ipc.send('close')
      })

      $( '.searchInput' )
      // don't navigate away from the field on tab when selecting an item
      .on( "keydown", function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB && $( this ).autocomplete( "instance" ).menu.active ) {
          event.preventDefault();
        }
      }).autocomplete({
        source: function( request, response ) {
          var search = request.term.split(/\s+/).pop()
          ipc.send('tags:require', search)
          ipc.once("tags:view", (e, _tags) => {
            response( _tags.tag )
          })
        },
        search: function() {
          // custom minLength
          var term = this.value.split(/\s+/).pop()
          if ( term.length == 0 ) {
            return false
          }
        },
        focus: function() {
          // prevent value inserted on focus
          return false;
        },
        select: function( event, ui ) {
          var terms = this.value.split(/\s+/)
          terms.pop()
          terms.push( ui.item.name )
          terms.push( "" );
          this.value = terms.join( " " );
          return false;
        }
      }).autocomplete( "instance" )._renderItem = function( ul, item ) {
        return $( "<li>" )
          .append( `<span class="tag-type-${item.type}">${item.name}</span> <span class="tag-count">${item.count}</span>` )
          .appendTo( ul )
      }
    })

function clickOnPaginationButtons(e) {
  var ipc = e.data.ipc
  var tags = $('.searchInput').val()
  var page = $('.content_detail__pagination').attr('actpage') - 1
  var href = $(this).attr('href')
  if (/[-+]1/.test(href)) {
    page = /-1/.test(href) ? page - 1 : page + 1
  } else page = href.match(/\d+/)[0]
  $('.gallery').append(`<div class="loading">${loading}</div>`)
  $('.animate-box').remove()

  ipc.send("gallery:require", page, tags)
  ipc.once("gallery:view", (e, gallery, images) => {
    $('.loading').remove()
    $.each(gallery.post, function( index, value ) {
      $('.pagination-trigger').before(buildPost(value))
    })

    $('.fa-eye').on('click', function() {
      Spotlight.show(images, spotlightConfig($(this)))
    })
    $('[data-bs-toggle=tooltip]').tooltip()

    displayGalleryAnimations()
  })
}

const loading = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin:auto;display:block;" width="200px" height="200px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
<clipPath id="cp">
  <path d="M0 -40.5 A40.5 40.5 0 0 1 0 40.5 A40.5 40.5 0 0 1 0 -40.5 M23.5 -1L23.5 1L30.5 1L30.5 -1Z"></path>
</clipPath>
<g transform="translate(50,50)">
<circle clip-path="url(#cp)" cx="0" cy="0" fill="none" r="26" stroke="#abbd81" stroke-width="5" stroke-dasharray="40.840704496667314 0 0 0 0 163.36281798666926">
<animate attributeName="stroke-dasharray" dur="1s" repeatCount="indefinite" begin="-0.1s" keyTimes="0;0.2;0.4;0.6;0.8;1" values="
0 0 0 0 0 163.36281798666926;
0 0 0 0 0 163.36281798666926;
0 0 81.68140899333463 0 0 163.36281798666926;
0 0 163.36281798666926 0 0 163.36281798666926;
0 0 81.68140899333463 0 0 163.36281798666926;
0 0 0 0 0 163.36281798666926
"></animate>
<animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" begin="-0.1s" values="0;0;0;0;180;360"></animateTransform>
</circle>

<circle cx="0" cy="0" fill="none" r="32" stroke="#f8b26a" stroke-width="5" stroke-dasharray="100.53096491487338 0 0 201.06192982974676">
<animate attributeName="stroke-dasharray" dur="1s" repeatCount="indefinite" begin="0s" values="
0 0 0 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 100.53096491487338 0 0 201.06192982974676;
0 0 0 0 0 201.06192982974676
"></animate>
<animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" begin="0s" values="0;0;0;180;180;360"></animateTransform>
</circle>

<circle cx="0" cy="0" fill="none" r="38" stroke="#e15b64" stroke-width="5" stroke-dasharray="119.38052083641213 0 0 238.76104167282426" transform="rotate(45)">
<animate attributeName="stroke-dasharray" dur="1s" repeatCount="indefinite" begin="0s" keyTimes="0;0.06;0.1;0.3;0.45;0.5;0.7;0.90;1" values="
0 0 89.5353906273091 0 0 238.76104167282426;
0 0 89.5353906273091 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 29.845130209103033 0 0 238.76104167282426;
0 0 29.845130209103033 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 119.38052083641213 0 0 238.76104167282426;
0 0 89.5353906273091 0 0 238.76104167282426
"></animate>
<animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" begin="0s" keyTimes="0;0.06;0.1;0.3;0.5;0.6;0.8;0.90;1" values="-60;0;0;0;180;180;180;180;300"></animateTransform>
</circle>
</g>
</svg>`

    function displayGalleryAnimations() {
      var next = 0
      myInterval = setInterval(function () {
        if (next == $('.animate-box').length) {
          clearInterval(myInterval)
        } else {
          $($('.animate-box')[next++]).addClass('fadeInUp animated')
        }
      }, 50);
    }

    function paginationFunctions() {
      // source: https://codepen.io/jsnanigans/full/dXAYBJ
      var paginationPage = parseInt($('.cdp').attr('actpage'), 10);
      $('.cdp_i').on('click', function(){
        var go = $(this).attr('href').replace('#!', '');
        if (go === '+1') {
          paginationPage++;
        } else if (go === '-1') {
          paginationPage--;
        }else{
          paginationPage = parseInt(go, 10);
        }
        $('.cdp').attr('actpage', paginationPage);
      });
    }

function buildPost(post) {
  var is_video = /\.(webm|mp4)$/.test(post.file_url)
  var video_post_icon = `<div class="video-post-icon"><i class="fa-regular fa-circle-play"></i></div>`
  var is_gif = /\.gif$/.test(post.file_url)
  var gif_post_icon = `<div class="video-post-icon"><i class="fa-solid fa-photo-film"></i></div>`
  var post_icon = null, post_source = null
  
  var image = post.sample_url ? post.sample_url : post.file_url

  if (is_video) {
    post_icon_html = video_post_icon
    post_source = `data-src-mp4="${post.file_url}" data-src-webm="https://img3.gelbooru.com/images/${post.directory}/${post.image}" data-poster="${post.preview_url}"`
  }
  else if (is_gif) {
    post_icon_html = gif_post_icon
    post_source = `href="${image}"`
  }
  else {
    post_icon_html = ""
    post_source = `href="${image}"`
  }

  return `<div class="animate-box" data-tags="${post.tags}">
            <div class="card__image">
              <a class="spotlight" ${post_source}>
                <img class="card__img" src="${post.preview_url}">
              </a>
              <div class="card__content">
                ${post_icon_html}
                <div class="card-icons">
                  <i class="fa-solid fa-eye" data-bs-toggle="tooltip" title="Ver"></i>
                  <i class="far fa-heart" data-bs-toggle="tooltip" title="Agregar a favoritos"></i>
                </div>
              </div>
            </div>
          </div>`
}

function buildPagination(gallery) {
  var count = gallery["@attributes"].count
  var limit = gallery["@attributes"].limit
  var offset = gallery["@attributes"].offset

  pages = Math.ceil(count / limit)

  if (pages <= 1)
    return ''
  else if (pages > 500)
    pages = 500

  var pages_html = ""
  for (var i=1; i<=pages; i++) {
    pages_html += `<a href="#!${i}" class="cdp_i">${i}</a>`
  }

  return `<div class="pagination-trigger">
            <div class="content_detail__pagination cdp" actpage="1">
              <a href="#!-1" class="cdp_i">prev</a>
              ${pages_html}
              <a href="#!+1" class="cdp_i">next</a>
            </div>
          </div>`
}

// Spotlight:   https://github.com/nextapps-de/spotlight
function spotlightConfig($this) {
  var clicked_index = $this.closest('.animate-box').index() + 1
  var tags = $this.closest('.animate-box').data('tags')
  console.log(tags.split(' '))
  var config = {
    animation: 'fade',
    page: false,
    theme: true,
    play: true,
    infinite: true,
    autohide: 1,
    //title: 'LocalBooru Gallery',
    spinner: true,
    download: true,
    index: clicked_index,
    //description: tags,
    //autoslide: true,
    //progress: false,
  }
  console.log(config)
  return config
}

  </script>
</body>
</html>